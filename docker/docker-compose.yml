services:
  # 后端服务
  backend:
    image: ghcr.io/wyf7685/dataforge/backend:latest
    restart: unless-stopped
    tty: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - backend_data:/app/data
      - external_data:/external
      - executor_data:/executor
    environment:
      - HOST=0.0.0.0
      - PORT=8081 # see nginx.conf
      - APP_IS_PROD=true
      - MAX_WORKERS=1
      - DREMIO_BASE_URL=http://dremio:9047
      - DREMIO_USERNAME=user
      - DREMIO_PASSWORD=password123
      - DREMIO_EXTERNAL_DIR=/external
      - DREMIO_EXTERNAL_NAME=external
      - EXECUTOR_DATA_DIR=/executor
      - CORS_ALLOW_ORIGINS=["*"]
      - REDIS_HOST=redis
      - JWT_SECRET_KEY=your_jwt_secret_key_here # 请在生产环境中更改此密钥
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      - ADMIN_USERNAME=admin # 管理员用户名
      - ADMIN_PASSWORD=admin123 # 管理员密码，请在生产环境中更改此密码
    depends_on:
      dremio:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test:
        - CMD-SHELL
        - curl -fsSL -o /dev/null --max-time 5 http://localhost:8081/api/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5

  # 前端服务 (Nginx)
  frontend:
    image: ghcr.io/wyf7685/dataforge/frontend:latest
    restart: unless-stopped
    ports:
      - '80:80'
    depends_on:
      backend:
        condition: service_healthy

  executor:
    image: ghcr.io/wyf7685/dataforge/executor:latest
    restart: unless-stopped
    volumes:
      - executor_data:/data
    command: ['python', '/executor.py', 'composed']

  # Dremio 服务
  dremio:
    image: dremio/dremio-oss:latest
    restart: unless-stopped
    ports:
      - '9047:9047' # UI 端口
    volumes:
      - dremio_data:/opt/dremio/data # 持久化数据
      - dremio_conf:/opt/dremio/conf # 持久化配置
      - external_data:/external # 挂载外部目录
    environment:
      - DREMIO_HEAP_SIZE_MB=4096 # 设置堆内存大小
      - DREMIO_MAX_DIRECT_MEMORY_MB=8192 # 设置直接内存大小
    healthcheck:
      test:
        - CMD-SHELL
        - curl -fsSL -o /dev/null --max-time 5 http://localhost:9047 || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Redis 服务 (缓存)
  redis:
    image: redis:alpine
    restart: unless-stopped

  # [可选] 备件预测MCP服务
  # spare_parts_forecast:
  #   image: ghcr.io/wyf7685/dataforge/spare-parts-forecast:latest
  #   restart: unless-stopped
  #   environment:
  #     - APP_HOST=0.0.0.0
  #     - APP_PORT=8000
  #     - AGENT_API_BASE_URL=http://backend:8081/api

  # [可选] 机器故障MCP服务
  # fault_diagnosis:
  #   image: ghcr.io/wyf7685/dataforge/fault-diagnosis:latest
  #   restart: unless-stopped
  #   environment:
  #     - APP_HOST=0.0.0.0
  #     - APP_PORT=8000
  #     - AGENT_API_BASE_URL=http://backend:8081/api

volumes:
  backend_data:
  dremio_data:
  dremio_conf:
  external_data:
  executor_data:
